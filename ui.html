<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi Agent Enterprise RAG Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
    textarea { width: 100%; }
    .chat-box { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
    .msg-user { color: #1a73e8; margin-bottom: 6px; }
    .msg-assistant { color: #0b8043; margin-bottom: 6px; }
    .section { margin-bottom: 20px; }
    button { padding: 6px 12px; }
    .status { font-size: 0.9em; color: #666; }

    .citation-snippet {
      margin-top: 4px;
      color: #666;
      font-size: 0.9em;
      white-space: pre-wrap;
    }
    details summary {
      cursor: pointer;
      user-select: none;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>Multi Agent RAG Demo</h1>


  <div class="section">
    <h2>1. Ingest documents</h2>
    <p>Enter local file paths (inside the app container) to ingest, one per line.</p>
    <textarea id="paths" rows="4" placeholder="./docs/document.pdf&#10;./docs/document.md&#10;./docs/document.txt"></textarea><br />
    <button onclick="ingest()">Ingest</button>
    <div id="ingest-status" class="status"></div>
  </div>


  <div class="section">
    <h2>2. Chat</h2>
    <div class="chat-box" id="chat-box"></div>
    <textarea id="question" rows="3" placeholder="Ask a question..."></textarea><br />
    <button onclick="sendMessage()">Send</button>
    <div id="chat-status" class="status"></div>
  </div>


  <script>
    const API_BASE = "";


    let sessionId = localStorage.getItem("rag_session_id") || "";
    let messages = [];


    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }


    function citationLabel(c) {
      const name = (c && c.source_name && String(c.source_name).trim()) ? c.source_name : null;
      const source = (c && c.source && String(c.source).trim()) ? c.source : null;
      const docId = (c && c.doc_id && String(c.doc_id).trim()) ? c.doc_id : null;

      const base = name || source || docId || "unknown";
      const page = (c && c.page !== undefined && c.page !== null && String(c.page).trim() !== "")
        ? ` p.${c.page}`
        : "";
      return `${base}${page}`;
    }


    function renderCitations(citations) {
      if (!Array.isArray(citations) || citations.length === 0) return "";

      const items = citations.map(c => {
        const label = citationLabel(c);
        const snippet = (c && c.snippet) ? String(c.snippet) : "";
        const snippetHtml = snippet
          ? `<div class="citation-snippet">${escapeHtml(snippet)}</div>`
          : "";
        return `<li><code>${escapeHtml(label)}</code>${snippetHtml}</li>`;
      }).join("");

      return `
        <div style="margin:6px 0 12px 0; font-size:0.9em; color:#444;">
          <div><strong>Citations</strong></div>
          <details>
            <summary>Show supporting text</summary>
            <ul style="margin:6px 0 0 18px; padding:0;">${items}</ul>
          </details>
        </div>
      `;
    }


    async function ingest() {
      const status = document.getElementById("ingest-status");
      const rawPaths = document.getElementById("paths").value.trim();
      if (!rawPaths) {
        status.textContent = "Please enter at least one path.";
        return;
      }

      const paths = rawPaths.split(/\r?\n/).map(p => p.trim()).filter(p => p);
      status.textContent = "Ingesting...";

      try {
        const resp = await fetch(API_BASE + "/ingest/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paths })
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          status.textContent = "Error: " + (err.detail || resp.statusText);
          return;
        }
        const data = await resp.json();
        if (data.session_id && String(data.session_id).trim()) {
          sessionId = data.session_id;
          localStorage.setItem("rag_session_id", sessionId);
        }

        status.textContent = `Ingestion complete. Indexed ${data.indexed_files.length} files.`;
      } catch (e) {
        status.textContent = "Network error: " + e;
      }
    }


    function renderChat() {
      const box = document.getElementById("chat-box");
      box.innerHTML = "";

      for (const m of messages) {
        const div = document.createElement("div");
        div.className = m.role === "user" ? "msg-user" : "msg-assistant";

        if (m.role === "assistant") {
          const answer = escapeHtml(m.content || "");
          const citationsHtml = renderCitations(m.citations);
          div.innerHTML = `Assistant: ${answer}${citationsHtml}`;
        } else {
          div.textContent = "You: " + (m.content || "");
        }

        box.appendChild(div);
      }

      box.scrollTop = box.scrollHeight;
    }


    async function sendMessage() {
      const status = document.getElementById("chat-status");
      const qEl = document.getElementById("question");
      const content = qEl.value.trim();
      if (!content) return;

      messages.push({ role: "user", content });
      renderChat();
      qEl.value = "";
      status.textContent = "Thinking...";

      try {
        const resp = await fetch(API_BASE + "/chat/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId, messages })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          status.textContent = "Error: " + (err.detail || resp.statusText);
          return;
        }

        const data = await resp.json();

        if (data.session_id) {
          sessionId = data.session_id;
        }

        messages.push({
          role: "assistant",
          content: data.answer,
          citations: Array.isArray(data.citations) ? data.citations : []
        });

        renderChat();
        status.textContent = "";
      } catch (e) {
        status.textContent = "Network error: " + e;
      }
    }
  </script>
</body>
</html>
